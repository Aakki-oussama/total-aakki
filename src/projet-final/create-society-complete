-- FONCTION: create_societe_complete
-- Crée une société, son solde, ses employés et ses véhicules en une seule fois.
-- Empêche les données orphelines si une étape échoue.

CREATE OR REPLACE FUNCTION create_societe_complete(
    p_nom_societe TEXT,
    p_employes JSONB,
    p_vehicules JSONB
)
RETURNS JSONB AS $$
DECLARE
    v_societe_id UUID;
    v_emp_count INTEGER := 0;
    v_veh_count INTEGER := 0;
    v_emp RECORD;
    v_veh RECORD;
BEGIN
    -- 1. Créer la société
    INSERT INTO societe (nom_societe)
    VALUES (p_nom_societe)
    RETURNING id INTO v_societe_id;

    -- 2. Créer le solde initial (via la fonction de ton système)
    PERFORM get_or_create_solde_societe(v_societe_id);

    -- 3. Insérer les employés
    IF p_employes IS NOT NULL AND jsonb_array_length(p_employes) > 0 THEN
        FOR v_emp IN SELECT * FROM jsonb_to_recordset(p_employes) AS x(nom TEXT, prenom TEXT)
        LOOP
            IF v_emp.nom != '' THEN
                INSERT INTO employe (societe_id, nom, prenom)
                VALUES (v_societe_id, v_emp.nom, v_emp.prenom);
                v_emp_count := v_emp_count + 1;
            END IF;
        END LOOP;
    END IF;

    -- 4. Insérer les véhicules
    IF p_vehicules IS NOT NULL AND jsonb_array_length(p_vehicules) > 0 THEN
        FOR v_veh IN SELECT * FROM jsonb_to_recordset(p_vehicules) AS x(matricule TEXT)
        LOOP
            IF v_veh.matricule != '' THEN
                INSERT INTO vehicule (societe_id, matricule)
                VALUES (v_societe_id, v_veh.matricule);
                v_veh_count := v_veh_count + 1;
            END IF;
        END LOOP;
    END IF;

    RETURN jsonb_build_object(
        'success', true,
        'societe_id', v_societe_id,
        'message', 'Société créée avec succès',
        'stats', jsonb_build_object('employes', v_emp_count, 'vehicules', v_veh_count)
    );
END;
$$ LANGUAGE plpgsql;